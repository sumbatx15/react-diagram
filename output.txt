import{StoreSlice}from".";import{Edge}from"./diagramStore";import{DiagramNode,EdgePosition,NodeState,Vector}from"./utils";exporttypeViewportSlice={viewport:{scale:number;position:Vector;updateScale:(scale:number)=>void;updatePosition:(position:Vector)=>void;};};//eslint-disable-next-linereact-func/max-lines-per-functionexportconstcreateViewportSlice:StoreSlice<ViewportSlice>=(set,get)=>({viewport:{scale:1,position:{x:0,y:0},updateScale:(scale)=>{set((state)=>({viewport:{...state.viewport,scale,},}));},updatePosition:(position)=>{set((state)=>({viewport:{...state.viewport,position,},}));},},});import{SpringValues}from"@react-spring/web";import{MutableRefObject}from"react";import{shallow}from"zustand/shallow";import{StoreState}from".";import{createHandleElementId}from"../utils";import{Edge,getCenterFromRect,getInDiagramPosition,useDiagram,}from"./diagramStore";import{ILayer}from"./layersStore";exportconstisConstrainProportions=(type:ILayer["type"])=>{return["image","icon"].includes(type);};exportconstcreateEdge=(edge:Omit<Edge,"id">)=>{return{id:`${edge.source}-${edge.sourceHandle}-${edge.target}-${edge.targetHandle}`,...edge,};};exportconstgetUpdatedLayer=(ref:MutableRefObject<HTMLDivElement|null>,values:SpringValues<{x:number;y:number;scale:number;rotate:number;}>)=>{return{width:ref.current?.offsetWidth||0,height:ref.current?.offsetHeight||0,rotate:values.rotate.get(),scale:values.scale.get(),x:values.x.get(),y:values.y.get(),};};exporttypeVector={x:number;y:number;};exportinterfaceNodeState{selected:boolean;dragging:boolean;disabled:boolean;}exportinterfaceDiagramNode{id:string;type?:string;position:Vector;data:unknown;state:NodeState;}exportinterfaceEdgePosition{start:Vector;end:Vector;}exportconstcreateZeroEdgePosition=()=>{return{start:{x:0,y:0},end:{x:0,y:0},};};exportconstcreateZeroVector=()=>{return{x:0,y:0};};exportconstgetSourceHandleRect=(state:StoreState,edge:Edge)=>{returnstate.elements[createHandleElementId(edge.source,edge.sourceHandle)].getBoundingClientRect();};exportconstgetTargetHandleRect=(state:StoreState,edge:Edge)=>{returnstate.elements[createHandleElementId(edge.target,edge.targetHandle)].getBoundingClientRect();};exportconstcreateEdgePosition=(state:StoreState,edge:Edge)=>{conststart=state.getHandleCenter(edge.source,edge.sourceHandle)||createZeroVector();constend=state.getHandleCenter(edge.target,edge.targetHandle)||createZeroVector();return{start,end,};};exportconstcreateEdgePositionFromRects=(sourceHandleRect:DOMRect,targetHandleRect:DOMRect)=>{return{start:getInDiagramPosition(getCenterFromRect(sourceHandleRect)),end:getInDiagramPosition(getCenterFromRect(targetHandleRect)),};};constareAllElementsVisible=(state:StoreState,edge:Edge)=>{return(state.elements[edge.source]&&state.elements[edge.target]&&state.elements[createHandleElementId(edge.source,edge.sourceHandle)]&&state.elements[createHandleElementId(edge.target,edge.targetHandle)]);};consthasChanges=(state:StoreState,prevState:StoreState,edge:Edge)=>{return(!shallow(state.nodePositions[edge.source],prevState.nodePositions[edge.source])||!shallow(state.nodePositions[edge.target],prevState.nodePositions[edge.target])||!shallow(state.elementRects[edge.source],prevState.elementRects[edge.source])||!shallow(state.elementRects[edge.target],prevState.elementRects[edge.target])||!shallow(state.elementRects[createHandleElementId(edge.source,edge.sourceHandle)],prevState.elementRects[createHandleElementId(edge.source,edge.sourceHandle)])||!shallow(state.elementRects[createHandleElementId(edge.target,edge.targetHandle)],prevState.elementRects[createHandleElementId(edge.target,edge.targetHandle)]));};exportconstupdateEdgePositionOnNodeMove=(state:StoreState,edge:Edge)=>{if(!areAllElementsVisible(state,edge))return;//constchanged=hasChanges(state,prev,edge);//console.log("changed:",changed);//if(!hasChanges(state,prev,edge))return;setTimeout(()=>{useDiagram.getState().updateEdgePosition(edge.id,createEdgePosition(state,edge));},10);};exporttypeDOMRectLike=Pick<DOMRect,"x"|"y"|"width"|"height"|"top"|"left"|"bottom"|"right">;exportconstgetUnscaledDOMRect=(rect:DOMRectLike,scale:number):DOMRectLike=>{if(scale===1)returnrect;return{x:rect.x/scale,y:rect.y/scale,width:rect.width/scale,height:rect.height/scale,top:rect.top/scale,left:rect.left/scale,bottom:rect.bottom/scale,right:rect.right/scale,};};interfaceGetRelativePositionOptions{containerRect:DOMRectLike;elementRect:DOMRectLike;}exportconstgetRelativePosition=({containerRect,elementRect,}:GetRelativePositionOptions)=>{return{x:elementRect.x-containerRect.x,y:elementRect.y-containerRect.y,};};exportconstgetUnscaledRelativePosition=({containerRect,elementRect,scale,}:GetRelativePositionOptions&{scale:number})=>{returngetRelativePosition({containerRect:getUnscaledDOMRect(containerRect,scale),elementRect:getUnscaledDOMRect(elementRect,scale),});};interfaceGetHandleCenterOptions{nodePosition:Vector;handleRelativeCenterOffset:Vector;}exportconstgetHandleCenter=({nodePosition,handleRelativeCenterOffset,}:GetHandleCenterOptions)=>{return{x:nodePosition.x+handleRelativeCenterOffset.x,y:nodePosition.y+handleRelativeCenterOffset.y,};};import{StoreSlice}from".";import{DiagramNode,NodeState,Vector}from"./utils";exporttypeNodesSlice={nodeIds:string[];nodePositions:Record<string,Vector>;nodeData:Record<string,unknown>;nodeStates:Record<string,NodeState>;updateNodePosition:(id:string,position:Vector)=>void;addNode:(node:DiagramNode)=>void;addNodes:(nodes:DiagramNode[])=>void;getNode:(id:string)=>DiagramNode|undefined;getNodePosition:(id:string)=>Vector|undefined;getNodeState:(id:string)=>NodeState|undefined;getNodeData:(id:string)=>unknown|undefined;getNodes:()=>DiagramNode[];nodeSizes:Record<string,DOMRectReadOnly>;updateNodeSize:(id:string,rect:DOMRectReadOnly)=>void;};//eslint-disable-next-linereact-func/max-lines-per-functionexportconstcreateNodesSlice:StoreSlice<NodesSlice>=(set,get)=>({nodeIds:[],nodePositions:{},nodeData:{},nodeStates:{},nodeSizes:{},addNode:(node)=>{set((state)=>({nodeIds:[...state.nodeIds,node.id],nodePositions:{...state.nodePositions,[node.id]:node.position,},nodeData:{...state.nodeData,[node.id]:node.data,},nodeStates:{...state.nodeStates,[node.id]:node.state,},}));},addNodes:(nodes)=>{set((state)=>({nodeIds:[...state.nodeIds,...nodes.map((node)=>node.id)],nodePositions:{...state.nodePositions,...nodes.reduce((acc,node)=>({...acc,[node.id]:node.position,}),{}),},nodeData:{...state.nodeData,...nodes.reduce((acc,node)=>({...acc,[node.id]:node.data,}),{}),},nodeStates:{...state.nodeStates,...nodes.reduce((acc,node)=>({...acc,[node.id]:node.state,}),{}),},}));},updateNodePosition:(id,position)=>{set((state)=>({nodePositions:{...state.nodePositions,[id]:position,},}));},getNode:(id)=>{conststate=get();return{id,position:state.nodePositions[id],state:state.nodeStates[id],data:state.nodeData[id],};},getNodes:()=>{conststate=get();returnstate.nodeIds.map((id)=>({id,position:state.nodePositions[id],state:state.nodeStates[id],data:state.nodeData[id],}));},getNodePosition:(id)=>{conststate=get();returnstate.nodePositions[id];},getNodeState:(id)=>{conststate=get();returnstate.nodeStates[id];},getNodeData:(id)=>{conststate=get();returnstate.nodeData[id];},updateNodeSize:(id,rect)=>{set((state)=>({nodeSizes:{...state.nodeSizes,[id]:rect,},}));},});import{debounce,merge,mapValues,pickBy,transform}from"lodash-es";import{StoreSlice}from".";import{CustomHTMLElement}from"../utils/CustomHTMLElement";import{singletonIntersectionObserver}from"../utils/SingletonIntersectionObserver";import{createZeroVector,DOMRectLike,getHandleCenter,getRelativePosition,getUnscaledDOMRect,Vector,}from"./utils";exportinterfaceHandleDimension{unscaledRect:DOMRectLike;relativePosition:Vector;relativeCenterOffset:Vector;}exportinterfaceNodeInternals{position:Vector;nodeElement:Element;unscaledNodeRect:DOMRectLike;handlesElement:Record<string,Element>;handlesDimensions:Record<string,HandleDimension>;}exporttypeNodeInternalsSlice={nodeInternals:Record<string,NodeInternals>;setNodeElement:(nodeId:string,element:Element)=>void;_debouncedUpdater:DebouncedUpdater;setHandleElement:(nodeId:string,handleId:string,element:Element)=>void;getNodeInternals:(nodeId:string)=>NodeInternals;getHandleCenter:(nodeId:string,handleId:string)=>Vector;};classDebouncedUpdater<TUpdaterextends(internals:NodeInternalsSlice["nodeInternals"])=>void=(internals:NodeInternalsSlice["nodeInternals"])=>void>{privateinternals:NodeInternalsSlice["nodeInternals"]={};privateprocessInternals:()=>void;constructor(privateupdater:TUpdater){this.processInternals=debounce(()=>{this.updater(this.internals);this.internals={};},0);}asyncsetNodeElement(nodeId:string,element:Element,scale:number){constboundingClientRect=awaitsingletonIntersectionObserver.observe(elementasCustomHTMLElement);constunscaledNodeRect=getUnscaledDOMRect(boundingClientRect,scale);this.internals={...this.internals,[nodeId]:{...this.internals[nodeId],nodeElement:element,unscaledNodeRect,},};this.processInternals();}asyncsetHandleElement(nodeId:string,handleId:string,element:Element,scale:number){constboundingClientRect=awaitsingletonIntersectionObserver.observe(elementasCustomHTMLElement);constunscaledRect=getUnscaledDOMRect(boundingClientRect,scale);this.internals={...this.internals,[nodeId]:{...this.internals[nodeId],handlesElement:{...this.internals[nodeId]?.handlesElement,[handleId]:element,},handlesDimensions:{...this.internals[nodeId]?.handlesDimensions,[handleId]:{unscaledRect,relativePosition:createZeroVector(),relativeCenterOffset:createZeroVector(),},},},};this.processInternals();}}constcalcDimension=(nodeInternals:NodeInternalsSlice["nodeInternals"],nodeId:string,handleId:string,scale:number)=>{constelement=nodeInternals[nodeId].handlesElement[handleId];constunscaledHandleRect=nodeInternals[nodeId].handlesDimensions[handleId].unscaledRect;constunscaledNodeRect=nodeInternals[nodeId].unscaledNodeRect;if(!element||!unscaledNodeRect)return;constrelativePosition=getRelativePosition({containerRect:unscaledNodeRect,elementRect:unscaledHandleRect,});return{unscaledRect:unscaledHandleRect,relativePosition:relativePosition,relativeCenterOffset:{x:relativePosition.x+unscaledHandleRect.width/2,y:relativePosition.y+unscaledHandleRect.height/2,},};};constbuildHandleDimension=(internals:NodeInternalsSlice["nodeInternals"],scale:number):NodeInternalsSlice["nodeInternals"]=>{returnmapValues(internals,(nodeInternals,node)=>{consthandleDimensions=transform(nodeInternals.handlesElement,(result:Record<string,HandleDimension>,_,handleId)=>{constdimension=calcDimension(internals,node,handleId,scale);if(dimension)result[handleId]=dimension;},{});return{...nodeInternals,handlesDimensions:pickBy(handleDimensions),};});};//eslint-disable-next-linereact-func/max-lines-per-functionexportconstcreateNodeInternalsSlice:StoreSlice<NodeInternalsSlice>=(set,get)=>({nodeInternals:{},_debouncedUpdater:newDebouncedUpdater((internals)=>{//getallvaluesfromnodeInternalsbyinternalskeysconstoriginalInternals=pickBy(get().nodeInternals,(_,key)=>Object.keys(internals).includes(key));console.log('originalInternals:',originalInternals)constresult=buildHandleDimension(internals,get().viewport.scale);set({nodeInternals:merge({},get().nodeInternals,result)});}),getHandleCenter:(nodeId,handleId)=>{constnode=get().getNodeInternals(nodeId);constposition=get().getNodePosition(nodeId)||createZeroVector();if(!node||!node.handlesDimensions||!node.handlesDimensions[handleId])returncreateZeroVector();returngetHandleCenter({nodePosition:position,handleRelativeCenterOffset:node.handlesDimensions[handleId].relativeCenterOffset,});},getNodeInternals:(nodeId)=>get().nodeInternals[nodeId],setNodeElement:(nodeId,element)=>{get()._debouncedUpdater.setNodeElement(nodeId,element,get().viewport.scale);},setHandleElement:(nodeId,handleId,element)=>{get()._debouncedUpdater.setHandleElement(nodeId,handleId,element,get().viewport.scale);},});import{create}from"zustand";import{immer}from"zustand/middleware/immer";import{PosterizerOptions}from"potrace";importuniqidfrom"uniqid";exportconstdefaultPotraceOptions:PosterizerOptions={threshold:100,steps:4,};exportinterfaceILayer{id:string;type:"image"|"text"|"icon";width?:number;height?:number;rotate?:number;scale?:number;x?:number;y?:number;zIndex?:number;inverted?:boolean;content?:any;src:string;options?:PosterizerOptions;}exportinterfaceImageLayerextendsILayer{type:"image";src:string;options?:PosterizerOptions;}exportinterfaceTextLayerextendsILayer{type:"text";strokeWidth?:number;content?:string;}exportinterfaceIconLayerextendsILayer{type:"icon";name:string;}exporttypeAnyLayer=ImageLayer|TextLayer|IconLayer;interfaceLayersState{layers:ILayer[];selectedLayerId?:string;isSelected:(id:string)=>boolean;getLayer:(id:string)=>ILayer|undefined;selectLayer:(id:string)=>void;getSelectedLayer:()=>ILayer|undefined;addLayer:(layer:ILayer)=>void;removeLayer:(id:string)=>void;removeSelectedLayer:()=>void;updateLayer:(id:string,layer:Partial<Omit<ILayer,"id">>)=>void;}exportconstuseLayers=create<LayersState,[["zustand/immer",never]]>(immer((set,get)=>({layers:[],selectedLayerId:undefined,getSelectedLayer:()=>get().getLayer(get().selectedLayerId||""),getLayer:(id)=>get().layers.find((layer)=>layer.id===id),selectLayer:(id)=>set((state)=>{state.selectedLayerId=id;}),isSelected:(id)=>id===get().selectedLayerId,addLayer:(layer)=>set((state)=>{state.layers.push(layer);}),removeLayer:(id)=>set((state)=>{state.layers=state.layers.filter((layer)=>layer.id!==id);}),removeSelectedLayer:()=>{get().removeLayer(get().selectedLayerId||"");},updateLayer:(id,layer)=>set((state)=>{constlayerIndex=state.layers.findIndex((l)=>l.id===id);state.layers[layerIndex]={...state.layers[layerIndex],...layer,};}),})));exportconstcreateLayer=<LextendsOmit<AnyLayer,"id">>(props:L):ILayer=>{return{id:uniqid(),...props,};};import{create,StateCreator}from"zustand";import{createNodesSlice,NodesSlice}from"./nodesSlice";import{createEdgesSlice,EdgesSlice}from"./edgesSlice";import{createDraggedEdgeSlice,DraggedEdgeSlice}from"./draggedEdgeSlice";import{createElementsSlice,ElementsSlice}from"./elementsSlice";import{createViewportSlice,ViewportSlice}from"./viewportSlice";import{subscribeWithSelector}from"zustand/middleware";import{createNodeInternalsSlice,NodeInternalsSlice,}from"./nodeInternalsSlice";exporttypeStoreState=NodesSlice&EdgesSlice&DraggedEdgeSlice&ElementsSlice&ViewportSlice&NodeInternalsSlice;exporttypeStoreSlice<T>=StateCreator<StoreState,[],[],T>;exportconstcreateDiagramStore=()=>{returncreate(subscribeWithSelector<StoreState>((set,get,store)=>({...createNodesSlice(set,get,store),...createEdgesSlice(set,get,store),...createDraggedEdgeSlice(set,get,store),...createElementsSlice(set,get,store),...createViewportSlice(set,get,store),...createNodeInternalsSlice(set,get,store),})));};import{StoreSlice}from".";import{Edge}from"./diagramStore";import{DiagramNode,EdgePosition,NodeState,Vector}from"./utils";import{debounce}from"lodash-es";classDebouncedUpdater<TItemextendsany,TUpdaterextends(items:TItem[])=>void=(items:TItem[])=>void>{privatequeue:TItem[]=[];privateprocessQueue=debounce((updater:TUpdater)=>{updater(this.queue);this.queue=[];},0);constructor(privateupdater:TUpdater){}addItem(item:TItem){this.queue.push(item);this.processQueue(this.updater);}}exporttypeElementsSlice={elements:Record<string,Element>;elementRects:Record<string,DOMRectReadOnly>;elementsDebounceUpdater:DebouncedUpdater<{id:string;element:Element;rect:DOMRectReadOnly;}>;setElement:(id:string,element:Element,rect:DOMRectReadOnly)=>void;setElementRects:(rectsMap:ElementsSlice["elementRects"])=>void;};//eslint-disable-next-linereact-func/max-lines-per-functionexportconstcreateElementsSlice:StoreSlice<ElementsSlice>=(set,get)=>({elements:{},elementRects:{},elementsDebounceUpdater:newDebouncedUpdater((items)=>{console.log("debouncedupdater",items);const{elements,elementRects}=items.reduce((acc,{id,element,rect})=>{acc.elements[id]=element;acc.elementRects[id]=rect;returnacc;},{elements:{},elementRects:{}}as{elements:ElementsSlice["elements"];elementRects:ElementsSlice["elementRects"];});set((state)=>({elements:{...state.elements,...elements,},elementRects:{...state.elementRects,...elementRects,},}));}),setElement:(id,element,rect)=>{get().elementsDebounceUpdater.addItem({id,element,rect});//console.log("setelement",id,);//set((state)=>({//elements:{//...state.elements,//[id]:element,//},//elementRects:{//...state.elementRects,//[id]:rect,//},//}));},setElementRects:(rects)=>{set((state)=>({elementRects:{...state.elementRects,...rects,},}));},});import{StoreSlice}from".";import{Edge}from"./diagramStore";import{createEdgePosition,createZeroEdgePosition,EdgePosition,}from"./utils";exporttypeEdgesSlice={edges:Edge[];edgePositions:Record<string,EdgePosition>;updateEdgePosition:(id:string,position:EdgePosition)=>void;addEdge:(edge:Edge)=>void;addEdges:(edges:Edge[])=>void;getEdge:(id:string)=>Edge|undefined;};//eslint-disable-next-linereact-func/max-lines-per-functionexportconstcreateEdgesSlice:StoreSlice<EdgesSlice>=(set,get)=>({edges:[],edgePositions:{},edgeData:{},updateEdgePosition:(id,position)=>{set((state)=>({edgePositions:{...state.edgePositions,[id]:position,},}));},addEdge:(edge)=>{set((state)=>({edges:[...state.edges,edge],edgePositions:{...state.edgePositions,[edge.id]:createZeroEdgePosition(),},}));},addEdges:(edges)=>{set((state)=>({edges:[...state.edges,...edges],}));},getEdge:(id)=>{conststate=get();returnstate.edges.find((edge)=>edge.id===id);},});import{StoreSlice}from".";import{Edge}from"./diagramStore";import{DiagramNode,EdgePosition,NodeState,Vector}from"./utils";exporttypeDraggedEdgeSlice={draggedEdge:EdgePosition;updateDraggedEdge:(position:Partial<EdgePosition>)=>void;isDraggedEdgeVisible:boolean;setDraggedEdgeVisible:(visible:boolean)=>void;};//eslint-disable-next-linereact-func/max-lines-per-functionexportconstcreateDraggedEdgeSlice:StoreSlice<DraggedEdgeSlice>=(set,get)=>({draggedEdge:{start:{x:0,y:0},end:{x:0,y:0},},updateDraggedEdge:(position)=>{set((state)=>({draggedEdge:{...state.draggedEdge,...position,},}));},isDraggedEdgeVisible:false,setDraggedEdgeVisible:(visible)=>{set((state)=>({isDraggedEdgeVisible:visible,}));},});importuniqidfrom"uniqid";import{StoreApi,UseBoundStore}from"zustand";import{createDiagramStore}from".";import{DiagramNode,EdgePosition,NodeState,Vector}from"./utils";constcreateVector=(x:number=Math.random()*500,y:number=Math.random()*500):Vector=>({x,y});constcreateNodeState=():NodeState=>({selected:false,dragging:false,disabled:false,});constcreateNodeData=():any=>({});exportconstcreateNode=()=>({id:uniqid(),position:createVector(),data:createNodeData(),state:createNodeState(),});exportinterfaceEdge{id:string;source:string;target:string;sourceHandle:string;targetHandle:string;data:unknown;}exporttype{EdgePosition};exporttype{DiagramNode};exportconstuseDiagram=createDiagramStore();//@ts-ignorewindow.useDiagram=useDiagram;exportconstgetInDiagramPosition=({x,y}:Vector)=>{const{position,scale}=useDiagram.getState().viewport;return{x:(x-position.x)/scale,y:(y-position.y)/scale,};};exportconstgetCenterFromRect=(rect:DOMRect)=>{return{x:rect.x+rect.width/2,y:rect.y+rect.height/2,};};